<% content_for :head do %>
<style>
  .hidden { display: none !important; }
</style>
<% end %>

<div class="bg-gradient-to-br from-amazon to-amazon-dark text-white p-5 shadow-md">
  <div class="max-w-4xl mx-auto flex justify-between items-center">
    <div>
      <h1 class="text-2xl font-bold mb-1">Saved Amazon Links</h1>
      <p class="text-sm opacity-90">Your Amazon product links from YouTube videos</p>
    </div>
    <div class="flex gap-4">
      <%= link_to "Home", root_path, class: "text-sm text-white/80 hover:text-white" %>
    </div>
  </div>
</div>

<!-- Not Authenticated Message -->
<div id="not-authenticated" class="hidden max-w-md mx-auto mt-15 bg-white rounded-xl p-8 shadow-lg text-center">
  <h2 class="mb-4 text-gray-800 text-xl font-semibold">Not Authenticated</h2>
  <p class="text-gray-600">Please open this page from the Chrome extension overlay.</p>
</div>

<!-- Links Section -->
<div id="links-section" class="hidden max-w-4xl mx-auto p-5">
  <div class="bg-white p-4 rounded-lg mb-5 shadow-sm">
    <span class="text-gray-600">Logged in as <strong id="user-email" class="text-gray-800"></strong></span>
  </div>

  <div id="loading" class="text-center py-10 text-gray-500">
    <div class="spinner mx-auto mb-4"></div>
    <p>Loading your links...</p>
  </div>

  <div id="links-grid" class="grid gap-5"></div>

  <div id="empty-state" class="hidden text-center py-15 text-gray-500">
    <h3 class="text-xl mb-2 text-gray-600 font-semibold">No links yet</h3>
    <p>Amazon links that you save from the extension will appear here.</p>
  </div>
</div>

<script>
  const API_BASE = window.location.origin;

  // Check for token in URL hash (passed from extension)
  if (window.location.hash) {
    const hashParams = new URLSearchParams(window.location.hash.substring(1));
    const hashToken = hashParams.get('token');
    const hashEmail = hashParams.get('email');
    if (hashToken) {
      localStorage.setItem('authToken', hashToken);
      if (hashEmail) localStorage.setItem('userEmail', hashEmail);
      // Clear the hash from URL
      history.replaceState(null, '', window.location.pathname);
    }
  }

  window.authToken = localStorage.getItem('authToken');
  window.userEmail = localStorage.getItem('userEmail');

  const notAuthenticated = document.getElementById('not-authenticated');
  const linksSection = document.getElementById('links-section');
  const userEmailEl = document.getElementById('user-email');
  const loadingEl = document.getElementById('loading');
  const linksGrid = document.getElementById('links-grid');
  const emptyState = document.getElementById('empty-state');

  async function loadLinks() {
    loadingEl.classList.remove('hidden');
    linksGrid.innerHTML = '';
    emptyState.classList.add('hidden');

    try {
      const response = await fetch(`${API_BASE}/amazon_links`, {
        headers: { 'Authorization': `Bearer ${window.authToken}` }
      });

      if (response.status === 401) {
        localStorage.removeItem('authToken');
        localStorage.removeItem('userEmail');
        linksSection.classList.add('hidden');
        notAuthenticated.classList.remove('hidden');
        return;
      }

      const amazonLinks = await response.json();

      loadingEl.classList.add('hidden');

      if (amazonLinks.length === 0) {
        emptyState.classList.remove('hidden');
        return;
      }

      amazonLinks.forEach(link => {
        linksGrid.appendChild(createLinkCard(link));
      });

    } catch (error) {
      loadingEl.classList.add('hidden');
      linksGrid.innerHTML = '<p class="text-center text-red-600">Failed to load links.</p>';
    }
  }

  function createLinkCard(link) {
    const card = document.createElement('div');
    card.className = 'bg-white rounded-xl overflow-hidden shadow-md transition-all duration-200 hover:-translate-y-0.5 hover:shadow-lg';

    const videosHtml = link.videos.map(video => {
      const thumbnailUrl = `https://img.youtube.com/vi/${video.youtube_id}/default.jpg`;
      const summaryHtml = video.summary_text
        ? `<p class="text-xs text-gray-500 mt-1 line-clamp-2">${escapeHtml(video.summary_text)}</p>`
        : '';
      return `
        <div class="p-2 bg-white border border-gray-200 rounded-md mb-2 transition-all hover:bg-gray-50 hover:border-gray-300 last:mb-0">
          <a href="${video.url}" target="_blank" rel="noopener noreferrer"
             class="flex items-center gap-3 no-underline text-gray-800">
            <img src="${thumbnailUrl}" alt="Video thumbnail" class="w-16 h-12 object-cover rounded shrink-0">
            <span class="flex-1 text-sm text-gray-700 overflow-hidden text-ellipsis whitespace-nowrap">${escapeHtml(video.title || 'Untitled Video')}</span>
            <svg class="text-gray-400 shrink-0" width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
              <path d="M14,3V5H17.59L7.76,14.83L9.17,16.24L19,6.41V10H21V3M19,19H5V5H12V3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V12H19V19Z"/>
            </svg>
          </a>
          ${summaryHtml}
        </div>
      `;
    }).join('');

    card.innerHTML = `
      <div class="p-4 bg-amazon-bg">
        <a href="${link.url}" target="_blank" rel="noopener noreferrer"
           class="flex items-center gap-3 p-3 bg-white border border-amazon-border rounded-md no-underline text-gray-800 transition-all hover:bg-amazon-light hover:border-amazon">
          <span class="w-8 h-8 bg-amazon text-white rounded-full flex items-center justify-center shrink-0">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M15.5 14h-.79l-.28-.27a6.5 6.5 0 1 0-.7.7l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0A4.5 4.5 0 1 1 14 9.5 4.5 4.5 0 0 1 9.5 14z"/>
            </svg>
          </span>
          <span class="flex-1 text-sm text-gray-700 overflow-hidden text-ellipsis whitespace-nowrap font-medium">${truncateUrl(link.url)}</span>
          <svg class="text-amazon shrink-0" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M14,3V5H17.59L7.76,14.83L9.17,16.24L19,6.41V10H21V3M19,19H5V5H12V3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V12H19V19Z"/>
          </svg>
        </a>
      </div>
      <div class="p-4">
        <div class="text-sm font-semibold text-gray-600 mb-3 flex items-center gap-1.5">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="text-red-500">
            <path d="M10 15l5.19-3L10 9v6m11.56-7.83c.13.47.22 1.1.28 1.9.07.8.1 1.49.1 2.09L22 12c0 2.19-.16 3.8-.44 4.83-.25.9-.83 1.48-1.73 1.73-.47.13-1.33.22-2.65.28-1.3.07-2.49.1-3.59.1L12 19c-4.19 0-6.8-.16-7.83-.44-.9-.25-1.48-.83-1.73-1.73-.13-.47-.22-1.1-.28-1.9-.07-.8-.1-1.49-.1-2.09L2 12c0-2.19.16-3.8.44-4.83.25-.9.83-1.48 1.73-1.73.47-.13 1.33-.22 2.65-.28 1.3-.07 2.49-.1 3.59-.1L12 5c4.19 0 6.8.16 7.83.44.9.25 1.48.83 1.73 1.73z"/>
          </svg>
          From ${link.videos.length} video${link.videos.length !== 1 ? 's' : ''}
        </div>
        ${videosHtml}
      </div>
    `;

    return card;
  }

  function truncateUrl(url) {
    try {
      const urlObj = new URL(url);
      if (urlObj.hostname === 'amzn.to') return url.replace(/^https?:\/\//, '');
      const dpMatch = urlObj.pathname.match(/\/dp\/([A-Z0-9]+)/i);
      if (dpMatch) return `amazon.com/dp/${dpMatch[1]}`;
      const gpMatch = urlObj.pathname.match(/\/gp\/product\/([A-Z0-9]+)/i);
      if (gpMatch) return `amazon.com/gp/${gpMatch[1]}`;
      const display = url.replace(/^https?:\/\/(www\.)?/, '');
      return display.length > 50 ? display.substring(0, 47) + '...' : display;
    } catch { return url.length > 50 ? url.substring(0, 47) + '...' : url; }
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Initialize page
  if (window.authToken) {
    linksSection.classList.remove('hidden');
    userEmailEl.textContent = window.userEmail || 'User';
    loadLinks();
  } else {
    notAuthenticated.classList.remove('hidden');
  }
</script>
